{% extends "base.html" %}

{% block title %}Calendar - CalDAV Web Client{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Multi-Calendar View</h4>
                <div class="btn-group">
                    <a href="{{ url_for('select_calendar') }}" class="btn btn-outline-primary">Manage Calendars</a>
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        Settings
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#calendarSidebar" id="sidebarToggle">
                        Calendars
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Debug info -->
                <div id="debugInfo" class="alert alert-info">
                    <strong>Debug:</strong> Loading calendar...
                </div>
                
                <!-- Collapsible Sidebar -->
                <div class="collapse mb-3" id="calendarSidebar">
                    <div class="card card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3">Active Calendars</h6>
                                <div id="calendarList">Loading calendars...</div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-3">Quick Actions</h6>
                                <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="refreshEvents()">
                                    Refresh Events
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Calendar -->
                <div id="calendar" style="min-height: 400px; border: 1px solid #ccc;">
                    <!-- Calendar will load here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simple Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="eventStartDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="eventStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventStartTime" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="eventStartTime" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventEndDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="eventEndDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventEndTime" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="eventEndTime" required>
                    </div>
                    <input type="hidden" id="eventId">
                    <input type="hidden" id="eventUrl">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteEventBtn" style="display: none;">Delete Event</button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">Save Event</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('Calendar script starting...');

// Global variables to fix scoping issues
let globalCalendar = null;
let globalEventModal = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing calendar...');
    
    const debugInfo = document.getElementById('debugInfo');
    const calendarEl = document.getElementById('calendar');
    const calendarListEl = document.getElementById('calendarList');
    
    try {
        // Update debug info
        debugInfo.innerHTML = '<strong>Debug:</strong> Initializing FullCalendar...';
        
        // Check if FullCalendar is loaded
        if (typeof FullCalendar === 'undefined') {
            throw new Error('FullCalendar not loaded');
        }
        
        globalCalendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            selectable: true,
            height: 'auto',
            events: function(fetchInfo, successCallback, failureCallback) {
                console.log('Fetching events...', fetchInfo);
                debugInfo.innerHTML = '<strong>Debug:</strong> Fetching events...';
                
                fetch(`/api/events?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`)
                    .then(response => {
                        console.log('Events response:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Events data:', data);
                        if (data.error) {
                            debugInfo.innerHTML = `<strong>Error:</strong> ${data.error}`;
                            failureCallback(data.error);
                        } else {
                            // Remove URLs from events to prevent .ics downloads
                            const cleanEvents = data.map(event => {
                                const cleanEvent = { ...event };
                                // Store the URL in extendedProps but remove it from the event object
                                if (cleanEvent.url) {
                                    cleanEvent.extendedProps = cleanEvent.extendedProps || {};
                                    cleanEvent.extendedProps.caldavUrl = cleanEvent.url;
                                    delete cleanEvent.url; // Remove URL to prevent download
                                }
                                return cleanEvent;
                            });
                            debugInfo.innerHTML = `<strong>Success:</strong> Loaded ${cleanEvents.length} events`;
                            successCallback(cleanEvents);
                        }
                    })
                    .catch(error => {
                        console.error('Events fetch error:', error);
                        debugInfo.innerHTML = `<strong>Error:</strong> ${error.message}`;
                        failureCallback(error);
                    });
            },
            dateClick: function(info) {
                console.log('Date clicked:', info.dateStr);
                openEventModal(info.dateStr);
            },
            eventClick: function(info) {
                console.log('Event clicked:', info.event);
                // Prevent default action (downloading .ics file)
                info.jsEvent.preventDefault();
                openEventModal(null, info.event);
            }
        });

        globalCalendar.render();
        debugInfo.innerHTML = '<strong>Success:</strong> Calendar rendered successfully';
        console.log('Calendar rendered successfully');
        
        // Load calendar list
        loadCalendarList();
        
    } catch (error) {
        console.error('Calendar initialization error:', error);
        debugInfo.innerHTML = `<strong>Error:</strong> ${error.message}`;
        calendarEl.innerHTML = `<div class="alert alert-danger">Error initializing calendar: ${error.message}</div>`;
    }
    
    // Initialize event modal
    globalEventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    
    // Save event functionality
    document.getElementById('saveEventBtn').addEventListener('click', function() {
        console.log('Save event clicked');
        
        const eventId = document.getElementById('eventId').value;
        const title = document.getElementById('eventTitle').value;
        const description = document.getElementById('eventDescription').value;
        const startDate = document.getElementById('eventStartDate').value;
        const startTime = document.getElementById('eventStartTime').value;
        const endDate = document.getElementById('eventEndDate').value;
        const endTime = document.getElementById('eventEndTime').value;
        
        if (!title.trim()) {
            alert('Please enter an event title');
            return;
        }
        
        const eventData = {
            title: title,
            description: description,
            start: `${startDate}T${startTime}:00`,
            end: `${endDate}T${endTime}:00`
        };
        
        if (document.getElementById('eventUrl').value) {
            eventData.url = document.getElementById('eventUrl').value;
        }
        
        const isUpdate = eventId && eventId.trim() !== '';
        const method = isUpdate ? 'PUT' : 'POST';
        const url = isUpdate ? `/api/events/${eventId}` : '/api/events';
        
        console.log('Saving event:', { method, url, eventData });
        
        // Disable save button
        const saveBtn = document.getElementById('saveEventBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(eventData)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Save response:', data);
            if (data.success) {
                globalEventModal.hide();
                // Use global calendar variable to refresh events
                if (globalCalendar) {
                    globalCalendar.refetchEvents();
                }
                showAlert('Event saved successfully!', 'success');
            } else {
                showAlert(`Error: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            showAlert('Error saving event', 'danger');
        })
        .finally(() => {
            // Re-enable save button
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Event';
        });
    });

    // Delete event functionality
    document.getElementById('deleteEventBtn').addEventListener('click', function() {
        console.log('Delete event clicked');
        
        const eventId = document.getElementById('eventId').value;
        const eventUrl = document.getElementById('eventUrl').value;
        const title = document.getElementById('eventTitle').value;
        
        if (!eventId || !eventUrl) {
            showAlert('Cannot delete event: missing event information', 'danger');
            return;
        }
        
        if (!confirm(`Are you sure you want to delete "${title}"?`)) {
            return;
        }
        
        console.log('Deleting event:', { eventId, eventUrl });
        
        // Disable delete button
        const deleteBtn = document.getElementById('deleteEventBtn');
        deleteBtn.disabled = true;
        deleteBtn.textContent = 'Deleting...';
        
        fetch(`/api/events/${eventId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: eventUrl })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Delete response:', data);
            if (data.success) {
                globalEventModal.hide();
                if (globalCalendar) {
                    globalCalendar.refetchEvents();
                }
                showAlert('Event deleted successfully!', 'success');
            } else {
                showAlert(`Error deleting event: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            showAlert('Error deleting event', 'danger');
        })
        .finally(() => {
            // Re-enable delete button
            deleteBtn.disabled = false;
            deleteBtn.textContent = 'Delete Event';
        });
    });
    
    function openEventModal(dateStr, event = null) {
        console.log('Opening event modal:', { dateStr, event });
        
        if (event) {
            // Editing existing event
            document.getElementById('eventModalLabel').textContent = 'Edit Event';
            document.getElementById('eventTitle').value = event.title || '';
            document.getElementById('eventDescription').value = event.extendedProps?.description || '';
            document.getElementById('eventId').value = event.id || '';
            
            // Get CalDAV URL from extendedProps
            const caldavUrl = event.extendedProps?.caldavUrl || event.extendedProps?.url || '';
            document.getElementById('eventUrl').value = caldavUrl;
            
            // Show delete button for existing events
            document.getElementById('deleteEventBtn').style.display = 'inline-block';
            
            // Parse dates
            const startDate = new Date(event.start);
            const endDate = new Date(event.end || event.start);
            
            document.getElementById('eventStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('eventEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('eventStartTime').value = startDate.toTimeString().slice(0, 5);
            document.getElementById('eventEndTime').value = endDate.toTimeString().slice(0, 5);
        } else {
            // Creating new event
            document.getElementById('eventModalLabel').textContent = 'New Event';
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('eventUrl').value = '';
            
            // Hide delete button for new events
            document.getElementById('deleteEventBtn').style.display = 'none';
            
            if (dateStr) {
                document.getElementById('eventStartDate').value = dateStr;
                document.getElementById('eventEndDate').value = dateStr;
                document.getElementById('eventStartTime').value = '09:00';
                document.getElementById('eventEndTime').value = '10:00';
            }
        }
        
        globalEventModal.show();
    }
    
    function loadCalendarList() {
        console.log('Loading calendar list...');
        
        fetch('/api/calendar-selection')
            .then(response => response.json())
            .then(data => {
                console.log('Calendar list data:', data);
                if (data.calendars) {
                    let html = '';
                    data.calendars.forEach((cal, index) => {
                        const calName = Array.isArray(cal) ? cal[0] : cal;
                        html += `<div class="mb-1">ðŸ“… ${calName}</div>`;
                    });
                    calendarListEl.innerHTML = html;
                } else {
                    calendarListEl.innerHTML = '<div class="text-muted">No calendars found</div>';
                }
            })
            .catch(error => {
                console.error('Error loading calendars:', error);
                calendarListEl.innerHTML = '<div class="text-danger">Error loading calendars</div>';
            });
    }
    
    function showAlert(message, type) {
        // Create alert element
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.style.position = 'fixed';
        alert.style.top = '20px';
        alert.style.right = '20px';
        alert.style.zIndex = '9999';
        alert.style.minWidth = '300px';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        
        document.body.appendChild(alert);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alert.parentElement) {
                alert.remove();
            }
        }, 5000);
    }
    
    // Global functions
    window.refreshEvents = function() {
        console.log('Refreshing events...');
        if (globalCalendar) {
            globalCalendar.refetchEvents();
        }
    };
    
    // Make functions globally available
    window.openEventModal = openEventModal;
    window.loadCalendarList = loadCalendarList;
    window.showAlert = showAlert;
});

console.log('Calendar script loaded');
</script>
{% endblock %}