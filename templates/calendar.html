{% extends "base.html" %}

{% block title %}Calendar - CalDAV Web Client{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Multi-Calendar View</h4>
                <div class="btn-group">
                    <a href="{{ url_for('select_calendar') }}" class="btn btn-outline-primary">Manage Calendars</a>
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        Settings
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#calendarSidebar" id="sidebarToggle">
                        Calendars
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Collapsible Sidebar -->
                <div class="collapse mb-3" id="calendarSidebar">
                    <div class="card card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3">Active Calendars</h6>
                                <div id="calendarList"></div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-3">Quick Actions</h6>
                                <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="refreshEvents()">
                                    Refresh Events
                                </button>
                                <button class="btn btn-sm btn-outline-secondary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#settingsModal">
                                    Customize Colors
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Calendar -->
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Calendar Settings
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body settings-modal-body">
                <!-- Week Start Setting -->
                <div class="week-start-setting">
                    <label for="weekStart" class="form-label">
                        <i class="fas fa-calendar-week me-2"></i>Week Starts On
                    </label>
                    <select class="form-select" id="weekStart">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                    </select>
                    <small class="form-text mt-1 d-block">Choose which day your week starts on</small>
                </div>
                
                <!-- Calendar Colors Section -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="form-label mb-0">
                            <i class="fas fa-palette me-2"></i>Calendar Colors
                        </label>
                        <div class="btn-group btn-group-sm bulk-actions">
                            <button type="button" class="btn btn-outline-secondary" onclick="resetAllColors()">
                                <i class="fas fa-undo me-1"></i>Reset All
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="randomizeColors()">
                                <i class="fas fa-random me-1"></i>Randomize
                            </button>
                        </div>
                    </div>
                    <small class="text-muted mb-2 d-block">Customize the color for each calendar</small>
                    <div id="colorSettings" class="color-settings-grid">
                        <!-- Color settings will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">
                    <i class="fas fa-save me-1"></i>Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">New Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="mb-3">
                        <label for="eventCalendar" class="form-label">Calendar</label>
                        <select class="form-select" id="eventCalendar"></select>
                    </div>
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="eventStartDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="eventStartDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="eventStartTime" class="form-label">Start Time</label>
                                <div class="time-picker-container">
                                    <input type="time" class="form-control time-input" id="eventStartTime" required>
                                    <div class="time-picker-overlay" id="startTimePicker">
                                        <div class="time-picker-grid">
                                            <select class="form-select time-picker-select" id="startHour"></select>
                                            <span class="time-picker-label">:</span>
                                            <select class="form-select time-picker-select" id="startMinute"></select>
                                            <span class="time-picker-label"></span>
                                            <select class="form-select time-picker-select" id="startAMPM">
                                                <option value="AM">AM</option>
                                                <option value="PM">PM</option>
                                            </select>
                                        </div>
                                        <div class="mt-2 text-end">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="applyTime('start')">Apply</button>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="closeTimePicker('start')">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="eventEndDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="eventEndDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="eventEndTime" class="form-label">End Time</label>
                                <div class="time-picker-container">
                                    <input type="time" class="form-control time-input" id="eventEndTime" required>
                                    <div class="time-picker-overlay" id="endTimePicker">
                                        <div class="time-picker-grid">
                                            <select class="form-select time-picker-select" id="endHour"></select>
                                            <span class="time-picker-label">:</span>
                                            <select class="form-select time-picker-select" id="endMinute"></select>
                                            <span class="time-picker-label"></span>
                                            <select class="form-select time-picker-select" id="endAMPM">
                                                <option value="AM">AM</option>
                                                <option value="PM">PM</option>
                                            </select>
                                        </div>
                                        <div class="mt-2 text-end">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="applyTime('end')">Apply</button>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="closeTimePicker('end')">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="allDayEvent">
                        <label class="form-check-label" for="allDayEvent">All Day Event</label>
                    </div>
                    <input type="hidden" id="eventId">
                    <input type="hidden" id="eventUrl">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteEventBtn" style="display: none;">Delete</button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">Save Event</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendarListEl = document.getElementById('calendarList');
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
    
    let userSettings = { week_start: 0, calendar_colors: {} };
    
    const defaultCalendarColors = [
        '#3788d8', '#28a745', '#dc3545', '#ffc107', '#6f42c1',
        '#fd7e14', '#20c997', '#e83e8c', '#6c757d', '#17a2b8'
    ];

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        firstDay: 0,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        selectable: true,
        height: '80vh',
        events: function(fetchInfo, successCallback, failureCallback) {
            fetch(`/api/events?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        failureCallback(data.error);
                    } else {
                        successCallback(data);
                    }
                })
                .catch(error => {
                    failureCallback(error);
                });
        },
        dateClick: function(info) {
            openEventModal(info.dateStr);
        },
        eventClick: function(info) {
            openEventModal(null, info.event);
        }
    });

    calendar.render();
    
    // Initialize time pickers
    initializeTimePickers();
    
    // Load calendar list
    loadCalendarList();
    loadSettings();

    function initializeTimePickers() {
        // Populate hour options (1-12)
        ['startHour', 'endHour'].forEach(id => {
            const select = document.getElementById(id);
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i.toString().padStart(2, '0');
                option.textContent = i.toString();
                select.appendChild(option);
            }
        });

        // Populate minute options (00-59, every 5 minutes)
        ['startMinute', 'endMinute'].forEach(id => {
            const select = document.getElementById(id);
            for (let i = 0; i < 60; i += 5) {
                const option = document.createElement('option');
                option.value = i.toString().padStart(2, '0');
                option.textContent = i.toString().padStart(2, '0');
                select.appendChild(option);
            }
        });

        // Add click handlers for time inputs
        document.getElementById('eventStartTime').addEventListener('click', function() {
            showTimePicker('start', this.value);
        });

        document.getElementById('eventEndTime').addEventListener('click', function() {
            showTimePicker('end', this.value);
        });

        // Close time pickers when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.time-picker-container')) {
                closeAllTimePickers();
            }
        });
    }

    function showTimePicker(type, currentValue) {
        closeAllTimePickers();
        
        const picker = document.getElementById(type + 'TimePicker');
        const hourSelect = document.getElementById(type + 'Hour');
        const minuteSelect = document.getElementById(type + 'Minute');
        const ampmSelect = document.getElementById(type + 'AMPM');
        
        // Parse current time or set defaults
        let hour = 9, minute = 0, ampm = 'AM';
        
        if (currentValue) {
            const [h, m] = currentValue.split(':');
            const hour24 = parseInt(h);
            minute = parseInt(m);
            
            if (hour24 === 0) {
                hour = 12;
                ampm = 'AM';
            } else if (hour24 < 12) {
                hour = hour24;
                ampm = 'AM';
            } else if (hour24 === 12) {
                hour = 12;
                ampm = 'PM';
            } else {
                hour = hour24 - 12;
                ampm = 'PM';
            }
        }
        
        hourSelect.value = hour.toString().padStart(2, '0');
        minuteSelect.value = Math.round(minute / 5) * 5;
        ampmSelect.value = ampm;
        
        picker.style.display = 'block';
    }

    function closeAllTimePickers() {
        document.querySelectorAll('.time-picker-overlay').forEach(picker => {
            picker.style.display = 'none';
        });
    }

    window.closeTimePicker = function(type) {
        document.getElementById(type + 'TimePicker').style.display = 'none';
    };

    window.applyTime = function(type) {
        const hourSelect = document.getElementById(type + 'Hour');
        const minuteSelect = document.getElementById(type + 'Minute');
        const ampmSelect = document.getElementById(type + 'AMPM');
        
        let hour = parseInt(hourSelect.value);
        const minute = parseInt(minuteSelect.value);
        const ampm = ampmSelect.value;
        
        // Convert to 24-hour format
        if (ampm === 'AM' && hour === 12) {
            hour = 0;
        } else if (ampm === 'PM' && hour !== 12) {
            hour += 12;
        }
        
        const timeString = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        document.getElementById('event' + type.charAt(0).toUpperCase() + type.slice(1) + 'Time').value = timeString;
        
        closeTimePicker(type);
    };

    function loadSettings() {
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                userSettings = data;
                calendar.setOption('firstDay', data.week_start || 0);
                document.getElementById('weekStart').value = data.week_start || 0;
            })
            .catch(error => {
                console.error('Error loading settings:', error);
            });
    }

    function loadCalendarList() {
        fetch('/api/calendar-selection')
            .then(response => response.json())
            .then(data => {
                if (data.calendars && data.selected_calendars) {
                    userSettings.calendar_colors = data.calendar_colors || {};
                    updateCalendarSidebar(data.selected_calendars, data.selected_calendars);
                    updateColorSettings(data.calendars);
                }
            })
            .catch(error => {
                console.error('Error loading calendar list:', error);
            });
    }

    function getCalendarColor(calName, index) {
        return userSettings.calendar_colors[calName] || defaultCalendarColors[index % defaultCalendarColors.length];
    }

    function updateCalendarSidebar(calendars, selectedCalendars) {
        let html = '';
        calendars.forEach((calInfo, index) => {
            const calName = Array.isArray(calInfo) ? calInfo[0] : calInfo;
            const color = getCalendarColor(calName, index);
            const isSelected = selectedCalendars.includes(calName);
            
            html += `
                <div class="form-check mb-2">
                    <input class="form-check-input calendar-toggle" type="checkbox" 
                           value="${calName}" id="cal_${index}" ${isSelected ? 'checked' : ''}
                           data-color="${color}">
                    <label class="form-check-label d-flex align-items-center" for="cal_${index}">
                        <span class="badge me-2" style="background-color: ${color}; width: 16px; height: 16px; border-radius: 50%;">&nbsp;</span>
                        <span class="flex-grow-1">${calName}</span>
                        ${isSelected ? '<i class="fas fa-eye text-success ms-1"></i>' : '<i class="fas fa-eye-slash text-muted ms-1"></i>'}
                    </label>
                </div>
            `;
        });
        
        calendarListEl.innerHTML = html;
        
        // Add event listeners
        document.querySelectorAll('.calendar-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateCalendarSelection();
                updateSidebarButtonText();
            });
        });
        
        updateSidebarButtonText();
        updateEventCalendarSelector(calendars);
    }

    function updateSidebarButtonText() {
        const selectedCount = document.querySelectorAll('.calendar-toggle:checked').length;
        const totalCount = document.querySelectorAll('.calendar-toggle').length;
        const sidebarToggle = document.getElementById('sidebarToggle');
        
        if (sidebarToggle) {
            sidebarToggle.innerHTML = `Calendars (${selectedCount}/${totalCount})`;
        }
    }

    function updateColorSettings(calendars) {
        const colorSettingsEl = document.getElementById('colorSettings');
        let html = '';
        
        calendars.forEach((calInfo, index) => {
            const calName = Array.isArray(calInfo) ? calInfo[0] : calInfo;
            const currentColor = getCalendarColor(calName, index);
            
            html += `
                <div class="color-setting-item">
                    <div class="calendar-name-label" title="${calName}">${calName}</div>
                    <div class="color-input-wrapper">
                        <input type="color" class="form-control form-control-color color-picker" 
                               value="${currentColor}" data-calendar="${calName}" 
                               onchange="updateCalendarColor('${calName}', this.value)"
                               title="Click to change color">
                        <button type="button" class="btn btn-sm btn-outline-secondary reset-color-btn" 
                                onclick="resetColor('${calName}', ${index})" 
                                title="Reset ${calName} to default color">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
            `;
        });
        
        colorSettingsEl.innerHTML = html;
    }

    function updateCalendarColorBadge(calName, color) {
        const badges = document.querySelectorAll('.calendar-color-badge');
        badges.forEach(badge => {
            const checkbox = badge.closest('.form-check').querySelector('input');
            if (checkbox && checkbox.value === calName) {
                badge.style.backgroundColor = color;
            }
        });
    }

    function updateEventCalendarSelector(calendars) {
        const selector = document.getElementById('eventCalendar');
        selector.innerHTML = '';
        calendars.forEach((calInfo) => {
            const calName = Array.isArray(calInfo) ? calInfo[0] : calInfo;
            const option = document.createElement('option');
            option.value = calName;
            option.textContent = calName;
            selector.appendChild(option);
        });
    }

    function updateCalendarSelection() {
        const selected = Array.from(document.querySelectorAll('.calendar-toggle:checked'))
                             .map(cb => cb.value);
        
        fetch('/api/calendar-selection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ calendars: selected })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                calendar.refetchEvents();
            }
        })
        .catch(error => {
            console.error('Error updating calendar selection:', error);
        });
    }

    function openEventModal(dateStr, event = null) {
        if (event) {
            document.getElementById('eventModalLabel').textContent = 'Edit Event';
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDescription').value = event.extendedProps.description || '';
            document.getElementById('deleteEventBtn').style.display = 'inline-block';
        } else {
            document.getElementById('eventModalLabel').textContent = 'New Event';
            document.getElementById('eventForm').reset();
            document.getElementById('deleteEventBtn').style.display = 'none';
            
            if (dateStr) {
                document.getElementById('eventStartDate').value = dateStr;
                document.getElementById('eventEndDate').value = dateStr;
                document.getElementById('eventStartTime').value = '09:00';
                document.getElementById('eventEndTime').value = '10:00';
            }
        }
        
        eventModal.show();
    }

    // Save settings
    document.getElementById('saveSettingsBtn').addEventListener('click', function() {
        const weekStart = parseInt(document.getElementById('weekStart').value);
        
        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                week_start: weekStart,
                calendar_colors: userSettings.calendar_colors
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                calendar.setOption('firstDay', weekStart);
                settingsModal.hide();
                calendar.refetchEvents();
                loadCalendarList();
            }
        });
    });
    
    window.refreshEvents = function() {
        calendar.refetchEvents();
    };

    window.resetColor = function(calName, index) {
        const defaultColor = defaultCalendarColors[index % defaultCalendarColors.length];
        delete userSettings.calendar_colors[calName];
        const colorPicker = document.querySelector(`input[data-calendar="${calName}"]`);
        if (colorPicker) colorPicker.value = defaultColor;
        updateCalendarColorBadge(calName, defaultColor);
    };

    window.updateCalendarColor = function(calName, color) {
        userSettings.calendar_colors[calName] = color;
        updateCalendarColorBadge(calName, color);
    };

    window.resetAllColors = function() {
        if (confirm('Reset all calendar colors to their defaults?')) {
            userSettings.calendar_colors = {};
            loadCalendarList();
        }
    };

    window.randomizeColors = function() {
        if (confirm('Assign random colors to all calendars?')) {
            const availableColors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
                '#F8C471', '#82E0AA', '#F1948A', '#85CDFD', '#FABE58'
            ];
            
            document.querySelectorAll('.color-picker').forEach((picker, index) => {
                const randomColor = availableColors[index % availableColors.length];
                picker.value = randomColor;
                updateCalendarColor(picker.dataset.calendar, randomColor);
            });
        }
    };
});
</script>
{% endblock %}
