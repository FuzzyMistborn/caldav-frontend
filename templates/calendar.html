{% extends "base.html" %}

{% block title %}Calendar - CalDAV Web Client{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Multi-Calendar View</h4>
                <div class="btn-group">
                    <a href="{{ url_for('select_calendar') }}" class="btn btn-outline-primary">Manage Calendars</a>
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        Settings
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#calendarSidebar" id="sidebarToggle">
                        Calendars
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Collapsible Sidebar -->
                <div class="collapse mb-3" id="calendarSidebar">
                    <div class="card card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3">Active Calendars</h6>
                                <div id="calendarList">Loading calendars...</div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-3">Quick Actions</h6>
                                <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="refreshEvents()">
                                    Refresh Events
                                </button>
                                <button class="btn btn-sm btn-outline-secondary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#settingsModal">
                                    Customize Colors
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Calendar -->
                <div id="calendar" style="position: relative;">
                    <div class="calendar-selection-hint" id="selectionHint">
                        ðŸ’¡ Drag to select date/time ranges for events
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Calendar Settings
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body settings-modal-body">
                <!-- Week Start Setting -->
                <div class="week-start-setting">
                    <label for="weekStart" class="form-label">
                        <i class="fas fa-calendar-week me-2"></i>Week Starts On
                    </label>
                    <select class="form-select" id="weekStart">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                    </select>
                    <small class="form-text mt-1 d-block">Choose which day your week starts on</small>
                </div>

                <!-- Default Calendar Setting -->
                <div class="week-start-setting">
                    <label for="defaultCalendar" class="form-label">
                        <i class="fas fa-calendar-plus me-2"></i>Default Calendar
                    </label>
                    <select class="form-select" id="defaultCalendar">
                        <option value="">Select default calendar...</option>
                    </select>
                    <small class="form-text mt-1 d-block">Calendar to use by default when creating new events</small>
                </div>
                
                <!-- Calendar Colors Section -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="form-label mb-0">
                            <i class="fas fa-palette me-2"></i>Calendar Colors
                        </label>
                        <div class="btn-group btn-group-sm bulk-actions">
                            <button type="button" class="btn btn-outline-secondary" onclick="resetAllColors()">
                                <i class="fas fa-undo me-1"></i>Reset All
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="randomizeColors()">
                                <i class="fas fa-random me-1"></i>Randomize
                            </button>
                        </div>
                    </div>
                    <small class="text-muted mb-2 d-block">Customize the color for each calendar</small>
                    <div id="colorSettings" class="color-settings-grid">
                        <!-- Color settings will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">
                    <i class="fas fa-save me-1"></i>Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">New Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="mb-3">
                        <label for="eventCalendar" class="form-label">Calendar</label>
                        <select class="form-select" id="eventCalendar"></select>
                    </div>
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="eventStartDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="eventStartDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="eventStartTime" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="eventStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="eventEndDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="eventEndDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="eventEndTime" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="eventEndTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="allDayEvent">
                        <label class="form-check-label" for="allDayEvent">All Day Event</label>
                    </div>
                    <input type="hidden" id="eventId">
                    <input type="hidden" id="eventUrl">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteEventBtn" style="display: none;">Delete</button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">Save Event</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Add this test at the very beginning
console.log('=== JAVASCRIPT STARTING ===');
alert('JavaScript is loading - check console for debug info');

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM CONTENT LOADED ===');
    const calendarEl = document.getElementById('calendar');
    const calendarListEl = document.getElementById('calendarList');
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
    
    let userSettings = { week_start: 0, calendar_colors: {} };
    
    const defaultCalendarColors = [
        '#3788d8', '#28a745', '#dc3545', '#ffc107', '#6f42c1',
        '#fd7e14', '#20c997', '#e83e8c', '#6c757d', '#17a2b8'
    ];

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        firstDay: 0,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        selectable: true,
        selectMirror: true,
        selectOverlap: true,
        selectConstraint: null,
        unselectAuto: true,
        height: '80vh',
        // Better all-day event display
        dayMaxEvents: true,
        dayMaxEventRows: 3,
        moreLinkClick: 'popover',
        eventOrder: function(a, b) {
            // All-day events first, then by start time
            if (a.allDay && !b.allDay) return -1;
            if (!a.allDay && b.allDay) return 1;
            return a.start - b.start;
        },
        eventDisplay: 'auto',
        displayEventTime: true,
        events: function(fetchInfo, successCallback, failureCallback) {
            fetch(`/api/events?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        failureCallback(data.error);
                    } else {
                        // Remove URLs from events to prevent .ics downloads and format all-day events
                        const cleanEvents = data.map(event => {
                            const cleanEvent = { ...event };
                            // Store the URL in extendedProps but remove it from the event object
                            if (cleanEvent.url) {
                                cleanEvent.extendedProps = cleanEvent.extendedProps || {};
                                cleanEvent.extendedProps.caldavUrl = cleanEvent.url;
                                delete cleanEvent.url; // Remove URL to prevent download
                            }
                            
                            // Handle all-day events properly
                            const startDate = new Date(cleanEvent.start);
                            const endDate = new Date(cleanEvent.end);
                            
                            // Check if this is an all-day event
                            const isAllDay = (startDate.getHours() === 0 && startDate.getMinutes() === 0 && 
                                            endDate.getHours() === 23 && endDate.getMinutes() === 59) ||
                                           (startDate.getHours() === 0 && startDate.getMinutes() === 0 && 
                                            endDate.getHours() === 0 && endDate.getMinutes() === 0);
                            
                            if (isAllDay) {
                                cleanEvent.allDay = true;
                                cleanEvent.classNames = ['all-day-event'];
                                // For all-day events spanning multiple days, ensure proper end date
                                if (startDate.toDateString() !== endDate.toDateString()) {
                                    // Multi-day all-day event
                                    cleanEvent.end = endDate.toISOString().split('T')[0];
                                } else {
                                    // Single day all-day event - don't set end to avoid issues
                                    delete cleanEvent.end;
                                }
                            }
                            
                            return cleanEvent;
                        });
                        successCallback(cleanEvents);
                    }
                })
                .catch(error => {
                    failureCallback(error);
                });
        },
        dateClick: function(info) {
            // Handle single day clicks with 30-minute rounding
            if (info.view.type === 'timeGridDay' || info.view.type === 'timeGridWeek') {
                // Time grid view - extract time from click and round to nearest 30 minutes
                const clickTime = new Date(info.date);
                
                // Round to nearest 30 minutes
                const minutes = clickTime.getMinutes();
                const roundedMinutes = Math.round(minutes / 30) * 30;
                
                const startTime = new Date(clickTime);
                startTime.setMinutes(roundedMinutes, 0, 0);
                
                // Default to 30-minute duration
                const endTime = new Date(startTime.getTime() + 30 * 60 * 1000);
                
                openEventModal(null, null, {
                    startDate: info.dateStr.split('T')[0],
                    endDate: info.dateStr.split('T')[0],
                    startTime: startTime.toTimeString().slice(0, 5),
                    endTime: endTime.toTimeString().slice(0, 5),
                    isMultiDay: false,
                    isTimed: true
                });
            } else {
                // Day grid view - regular day click
                openEventModal(null, null, {
                    startDate: info.dateStr,
                    endDate: info.dateStr,
                    isMultiDay: false
                });
            }
        },
        eventClick: function(info) {
            // Prevent default action (downloading .ics file)
            info.jsEvent.preventDefault();
            openEventModal(null, info.event);
        },
        select: function(info) {
            // Handle date range selection from FullCalendar's native selection with 30-minute rounding
            const startDate = new Date(info.start);
            const endDate = new Date(info.end);
            
            if (info.view.type === 'timeGridDay' || info.view.type === 'timeGridWeek') {
                // Time grid view - handle time selection and round to nearest 30 minutes
                const startMinutes = startDate.getMinutes();
                const endMinutes = endDate.getMinutes();
                
                // Round start time to nearest 30 minutes (down)
                const roundedStartMinutes = Math.floor(startMinutes / 30) * 30;
                startDate.setMinutes(roundedStartMinutes, 0, 0);
                
                // Round end time to nearest 30 minutes (up)
                const roundedEndMinutes = Math.ceil(endMinutes / 30) * 30;
                if (roundedEndMinutes >= 60) {
                    endDate.setHours(endDate.getHours() + 1);
                    endDate.setMinutes(0, 0, 0);
                } else {
                    endDate.setMinutes(roundedEndMinutes, 0, 0);
                }
                
                const startTime = startDate.toTimeString().slice(0, 5);
                const endTime = endDate.toTimeString().slice(0, 5);
                
                openEventModal(null, null, {
                    startDate: startDate.toISOString().split('T')[0],
                    endDate: endDate.toISOString().split('T')[0],
                    startTime: startTime,
                    endTime: endTime,
                    isMultiDay: startDate.toDateString() !== endDate.toDateString(),
                    isTimed: true
                });
            } else {
                // Day grid view - handle day selection
                // Calculate the actual end date (FullCalendar's end is exclusive for day grid)
                const actualEndDate = new Date(endDate);
                actualEndDate.setDate(actualEndDate.getDate() - 1);
                
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = actualEndDate.toISOString().split('T')[0];
                const isMultiDay = startDateStr !== endDateStr;
                
                openEventModal(null, null, {
                    startDate: startDateStr,
                    endDate: endDateStr,
                    isMultiDay: isMultiDay
                });
            }
            
            // Hide selection hint
            const hint = document.getElementById('selectionHint');
            if (hint) {
                hint.classList.remove('show');
            }
            
            // Clear the selection
            calendar.unselect();
        },
        selectAllow: function(selectInfo) {
            // Show hint when user starts selecting
            const hint = document.getElementById('selectionHint');
            if (hint && selectInfo.start.getTime() !== selectInfo.end.getTime()) {
                hint.classList.add('show');
            }
            return true; // Always allow selection
        },
        unselect: function(info) {
            // Hide hint when selection is cleared
            const hint = document.getElementById('selectionHint');
            if (hint) {
                hint.classList.remove('show');
            }
        },
    });

    calendar.render();
    
    // Multi-day selection handling for day grid
    let isSelecting = false;
    let selectionStart = null;
    let selectionEnd = null;
    let furthestDate = null; // Track the furthest date we've reached
    
    // Time-based selection handling for time grid
    let isTimeSelecting = false;
    let timeSelectionStart = null;
    let timeSelectionEnd = null;
    
    // Custom drag selection implementation for day grid
    calendarEl.addEventListener('mousedown', function(e) {
        const dayEl = e.target.closest('.fc-daygrid-day');
        const timeGridEl = e.target.closest('.fc-timegrid-col, .fc-timegrid-slot-lane, .fc-timegrid-slot, .fc-timegrid-col-frame');
        
        if (dayEl && e.button === 0 && !timeGridEl) {
            // Day grid selection
            isSelecting = true;
            selectionStart = dayEl.getAttribute('data-date');
            selectionEnd = selectionStart;
            furthestDate = selectionStart;
            e.preventDefault();
            dayEl.classList.add('selecting');
        } else if (timeGridEl && e.button === 0) {
            // Time grid selection
            const currentView = calendar.view;
            if (currentView.type === 'timeGridDay' || currentView.type === 'timeGridWeek') {
                isTimeSelecting = true;
                
                let col = e.target.closest('.fc-timegrid-col');
                let dayDate = null;
                
                if (col) {
                    dayDate = col.getAttribute('data-date');
                }
                
                if (!dayDate) {
                    const colIndex = Array.from(col?.parentElement?.children || []).indexOf(col);
                    const headerCells = document.querySelectorAll('.fc-col-header-cell');
                    if (headerCells[colIndex]) {
                        dayDate = headerCells[colIndex].getAttribute('data-date');
                    }
                }
                
                if (!dayDate) {
                    if (currentView.type === 'timeGridDay') {
                        dayDate = currentView.currentStart.toISOString().split('T')[0];
                    }
                }
                
                if (dayDate) {
                    const timeInfo = getTimeFromPosition(e, currentView);
                    
                    if (timeInfo) {
                        timeSelectionStart = {
                            date: dayDate,
                            time: timeInfo.time,
                            datetime: timeInfo.datetime,
                            element: timeGridEl
                        };
                        timeSelectionEnd = timeSelectionStart;
                        e.preventDefault();
                    } else {
                        isTimeSelecting = false;
                    }
                } else {
                    isTimeSelecting = false;
                }
            }
        }
    });
    
    function getCalendarColor(calName, index) {
        return userSettings.calendar_colors[calName] || defaultCalendarColors[index % defaultCalendarColors.length];
    }

    function updateCalendarSidebar(calendars, selectedCalendars) {
        console.log('updateCalendarSidebar called with:', { calendars, selectedCalendars });
        
        let html = '';
        calendars.forEach((calInfo, index) => {
            const calName = Array.isArray(calInfo) ? calInfo[0] : calInfo;
            const color = getCalendarColor(calName, index);
            const isSelected = selectedCalendars.includes(calName);
            
            console.log(`Calendar ${index}:`, { calName, color, isSelected });
            
            html += `
                <div class="form-check mb-2">
                    <input class="form-check-input calendar-toggle" type="checkbox" 
                           value="${calName}" id="cal_${index}" ${isSelected ? 'checked' : ''}
                           data-color="${color}">
                    <label class="form-check-label d-flex align-items-center" for="cal_${index}">
                        <span class="badge me-2" style="background-color: ${color}; width: 16px; height: 16px; border-radius: 50%;">&nbsp;</span>
                        <span class="flex-grow-1">${calName}</span>
                        ${isSelected ? '<i class="fas fa-eye text-success ms-1"></i>' : '<i class="fas fa-eye-slash text-muted ms-1"></i>'}
                    </label>
                </div>
            `;
        });
        
        if (html === '') {
            html = '<div class="text-warning">No calendars found</div>';
        }
        
        calendarListEl.innerHTML = html;
        
        // Add event listeners
        document.querySelectorAll('.calendar-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateCalendarSelection();
                updateSidebarButtonText();
            });
        });
        
        updateSidebarButtonText();
    }

    function updateSidebarButtonText() {
        const selectedCount = document.querySelectorAll('.calendar-toggle:checked').length;
        const totalCount = document.querySelectorAll('.calendar-toggle').length;
        const sidebarToggle = document.getElementById('sidebarToggle');
        
        if (sidebarToggle) {
            sidebarToggle.innerHTML = `Calendars (${selectedCount}/${totalCount})`;
        }
    }

    function updateColorSettings(calendars) {
        const colorSettingsEl = document.getElementById('colorSettings');
        let html = '';
        
        calendars.forEach((calInfo, index) => {
            const calName = Array.isArray(calInfo) ? calInfo[0] : calInfo;
            const currentColor = getCalendarColor(calName, index);
            
            html += `
                <div class="color-setting-item">
                    <div class="calendar-name-label" title="${calName}">${calName}</div>
                    <div class="color-input-wrapper">
                        <input type="color" class="form-control form-control-color color-picker" 
                               value="${currentColor}" data-calendar="${calName}" 
                               onchange="updateCalendarColor('${calName}', this.value)"
                               title="Click to change color">
                        <button type="button" class="btn btn-sm btn-outline-secondary reset-color-btn" 
                                onclick="resetColor('${calName}', ${index})" 
                                title="Reset ${calName} to default color">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
            `;
        });
        
        colorSettingsEl.innerHTML = html;
    }

    function updateCalendarColorBadge(calName, color) {
        const badges = document.querySelectorAll('.badge');
        badges.forEach(badge => {
            const checkbox = badge.closest('.form-check').querySelector('input');
            if (checkbox && checkbox.value === calName) {
                badge.style.backgroundColor = color;
            }
        });
    }

    function updateEventCalendarSelector(calendars) {
        console.log('updateEventCalendarSelector called with:', calendars);
        
        const selector = document.getElementById('eventCalendar');
        const defaultSelector = document.getElementById('defaultCalendar');
        
        if (!selector || !defaultSelector) {
            console.error('Calendar selectors not found in DOM');
            return;
        }
        
        // Update event calendar selector
        selector.innerHTML = '';
        calendars.forEach((calInfo) => {
            const calName = Array.isArray(calInfo) ? calInfo[0] : calInfo;
            console.log('Adding calendar option:', calName);
            
            const option = document.createElement('option');
            option.value = calName;
            option.textContent = calName;
            selector.appendChild(option);
        });
        
        // Update default calendar selector
        defaultSelector.innerHTML = '<option value="">Select default calendar...</option>';
        calendars.forEach((calInfo) => {
            const calName = Array.isArray(calInfo) ? calInfo[0] : calInfo;
            const option = document.createElement('option');
            option.value = calName;
            option.textContent = calName;
            defaultSelector.appendChild(option);
        });
        
        // Set default calendar value if it exists in settings
        if (userSettings.default_calendar) {
            defaultSelector.value = userSettings.default_calendar;
        }
        
        console.log('Event calendar selector updated. Options count:', selector.options.length);
        console.log('Default calendar selector updated. Options count:', defaultSelector.options.length);
    }

    function updateCalendarSelection() {
        const selected = Array.from(document.querySelectorAll('.calendar-toggle:checked'))
                             .map(cb => cb.value);
        
        fetch('/api/calendar-selection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ calendars: selected })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                calendar.refetchEvents();
            }
        })
        .catch(error => {
            console.error('Error updating calendar selection:', error);
        });
    }

    function openEventModal(dateStr, event = null, dateRange = null) {
        // Reset form
        document.getElementById('eventForm').reset();
        document.getElementById('eventId').value = '';
        document.getElementById('eventUrl').value = '';
        
        if (event) {
            // Editing existing event
            document.getElementById('eventModalLabel').textContent = 'Edit Event';
            document.getElementById('eventTitle').value = event.title || '';
            document.getElementById('eventDescription').value = event.extendedProps?.description || '';
            document.getElementById('deleteEventBtn').style.display = 'inline-block';
            
            // Set calendar
            if (event.extendedProps?.calendar_name) {
                document.getElementById('eventCalendar').value = event.extendedProps.calendar_name;
            }
            
            // Set event ID and URL for updates
            document.getElementById('eventId').value = event.id || '';
            document.getElementById('eventUrl').value = event.extendedProps?.caldavUrl || event.extendedProps?.url || '';
            
            // Parse dates
            const startDate = new Date(event.start);
            const endDate = new Date(event.end || event.start);
            
            // Check if all-day event (simple heuristic)
            const isAllDay = event.allDay || 
                            (startDate.getHours() === 0 && startDate.getMinutes() === 0 && 
                             endDate.getHours() === 23 && endDate.getMinutes() === 59);
            
            document.getElementById('allDayEvent').checked = isAllDay;
            
            // Set dates
            document.getElementById('eventStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('eventEndDate').value = endDate.toISOString().split('T')[0];
            
            if (!isAllDay) {
                // Set times
                document.getElementById('eventStartTime').value = 
                    startDate.toTimeString().slice(0, 5);
                document.getElementById('eventEndTime').value = 
                    endDate.toTimeString().slice(0, 5);
            }
            
            // Toggle time inputs based on all-day status
            toggleTimeInputs(isAllDay);
        } else {
            // Creating new event
            document.getElementById('eventModalLabel').textContent = 'New Event';
            document.getElementById('deleteEventBtn').style.display = 'none';
            
            // Handle date range selection or single date
            if (dateRange) {
                document.getElementById('eventStartDate').value = dateRange.startDate;
                document.getElementById('eventEndDate').value = dateRange.endDate;
                
                // Check if this is a timed selection (from time grid views)
                if (dateRange.isTimed) {
                    // Time-based selection - always use provided times
                    document.getElementById('allDayEvent').checked = false;
                    document.getElementById('eventStartTime').value = dateRange.startTime;
                    document.getElementById('eventEndTime').value = dateRange.endTime;
                    toggleTimeInputs(false);
                    
                    if (dateRange.isMultiDay) {
                        showToast(`Creating multi-day timed event from ${dateRange.startDate} ${dateRange.startTime} to ${dateRange.endDate} ${dateRange.endTime}`, 'info');
                    }
                } else {
                    // Day-based selection (from day grid views)
                    if (dateRange.isMultiDay) {
                        // Multi-day selection - default to all-day
                        document.getElementById('allDayEvent').checked = true;
                        toggleTimeInputs(true);
                        showToast(`Creating multi-day event from ${dateRange.startDate} to ${dateRange.endDate}`, 'info');
                    } else {
                        // Single day selection - default to timed
                        document.getElementById('allDayEvent').checked = false;
                        document.getElementById('eventStartTime').value = '09:00';
                        document.getElementById('eventEndTime').value = '10:00';
                        toggleTimeInputs(false);
                    }
                }
            } else if (dateStr) {
                // Single date click - timed event
                document.getElementById('eventStartDate').value = dateStr;
                document.getElementById('eventEndDate').value = dateStr;
                document.getElementById('eventStartTime').value = '09:00';
                document.getElementById('eventEndTime').value = '10:00';
                document.getElementById('allDayEvent').checked = false;
                toggleTimeInputs(false);
            }
            
            // Set default calendar
            const calendarSelector = document.getElementById('eventCalendar');
            const defaultCalendar = userSettings.default_calendar || 
                                  document.getElementById('defaultCalendar').value;
            if (defaultCalendar && calendarSelector) {
                calendarSelector.value = defaultCalendar;
            } else if (calendarSelector && calendarSelector.options.length > 0) {
                calendarSelector.selectedIndex = 0;
            }
        }
        
        eventModal.show();
    }

    function toggleTimeInputs(isAllDay) {
        const timeInputs = document.querySelectorAll('#eventStartTime, #eventEndTime');
        const timeLabels = document.querySelectorAll('label[for="eventStartTime"], label[for="eventEndTime"]');
        
        if (isAllDay) {
            timeInputs.forEach(input => {
                input.style.display = 'none';
                input.required = false;
            });
            timeLabels.forEach(label => {
                label.style.display = 'none';
            });
        } else {
            timeInputs.forEach(input => {
                input.style.display = 'block';
                input.required = true;
            });
            timeLabels.forEach(label => {
                label.style.display = 'block';
            });
        }
    }

    // Save settings
    document.getElementById('saveSettingsBtn').addEventListener('click', function() {
        const weekStart = parseInt(document.getElementById('weekStart').value);
        const defaultCalendar = document.getElementById('defaultCalendar').value;
        
        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                week_start: weekStart,
                default_calendar: defaultCalendar,
                calendar_colors: userSettings.calendar_colors
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                userSettings.default_calendar = defaultCalendar;
                calendar.setOption('firstDay', weekStart);
                settingsModal.hide();
                calendar.refetchEvents();
                loadCalendarList();
                showToast('Settings saved successfully!', 'success');
            }
        });
    });

    // Save event functionality
    document.getElementById('saveEventBtn').addEventListener('click', function() {
        const eventId = document.getElementById('eventId').value;
        const eventUrl = document.getElementById('eventUrl').value;
        const title = document.getElementById('eventTitle').value;
        const description = document.getElementById('eventDescription').value;
        const startDate = document.getElementById('eventStartDate').value;
        const startTime = document.getElementById('eventStartTime').value;
        const endDate = document.getElementById('eventEndDate').value;
        const endTime = document.getElementById('eventEndTime').value;
        const allDay = document.getElementById('allDayEvent').checked;
        const calendarName = document.getElementById('eventCalendar').value;

        // Validation
        if (!title.trim()) {
            showToast('Please enter an event title', 'warning');
            return;
        }

        if (!startDate || !endDate) {
            showToast('Please select start and end dates', 'warning');
            return;
        }

        // Build start and end datetime strings
        let startDateTime, endDateTime;
        
        if (allDay) {
            startDateTime = startDate + 'T00:00:00';
            endDateTime = endDate + 'T23:59:59';
        } else {
            if (!startTime || !endTime) {
                showToast('Please select start and end times', 'warning');
                return;
            }
            startDateTime = startDate + 'T' + startTime + ':00';
            endDateTime = endDate + 'T' + endTime + ':00';
        }

        // Prepare event data
        const eventData = {
            title: title,
            description: description,
            start: startDateTime,
            end: endDateTime,
            calendar_name: calendarName
        };

        // Add URL for updates
        if (eventUrl) {
            eventData.url = eventUrl;
        }

        // Determine if this is create or update
        const isUpdate = eventId && eventId.trim() !== '';
        const method = isUpdate ? 'PUT' : 'POST';
        const url = isUpdate ? `/api/events/${eventId}` : '/api/events';

        // Disable save button during request
        const saveBtn = document.getElementById('saveEventBtn');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        // Make API request
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(eventData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                eventModal.hide();
                calendar.refetchEvents();
                showToast('Event saved successfully!', 'success');
            } else {
                showToast(`Error saving event: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error saving event:', error);
            showToast('Error saving event. Please try again.', 'error');
        })
        .finally(() => {
            // Re-enable save button
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        });
    });

    // Delete event functionality
    document.getElementById('deleteEventBtn').addEventListener('click', function() {
        const eventId = document.getElementById('eventId').value;
        const eventUrl = document.getElementById('eventUrl').value;
        const title = document.getElementById('eventTitle').value;

        if (!eventId || !eventUrl) {
            showToast('Cannot delete event: missing event information', 'error');
            return;
        }

        if (!confirm(`Are you sure you want to delete "${title}"?`)) {
            return;
        }

        // Disable delete button during request
        const deleteBtn = document.getElementById('deleteEventBtn');
        const originalText = deleteBtn.textContent;
        deleteBtn.disabled = true;
        deleteBtn.textContent = 'Deleting...';

        fetch(`/api/events/${eventId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url: eventUrl })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                eventModal.hide();
                calendar.refetchEvents();
                showToast('Event deleted successfully!', 'success');
            } else {
                showToast(`Error deleting event: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting event:', error);
            showToast('Error deleting event. Please try again.', 'error');
        })
        .finally(() => {
            // Re-enable delete button
            deleteBtn.disabled = false;
            deleteBtn.textContent = originalText;
        });
    });

    // All-day event toggle
    document.getElementById('allDayEvent').addEventListener('change', function() {
        toggleTimeInputs(this.checked);
    });

    // Toast notification function
    function showToast(message, type = 'info') {
        // Create toast element if it doesn't exist
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
            `;
            document.body.appendChild(toastContainer);
        }

        // Create toast
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show`;
        toast.style.cssText = `
            margin-bottom: 10px;
            min-width: 300px;
        `;
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;

        toastContainer.appendChild(toast);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }
    
    // Global functions
    window.refreshEvents = function() {
        calendar.refetchEvents();
    };

    window.resetColor = function(calName, index) {
        const defaultColor = defaultCalendarColors[index % defaultCalendarColors.length];
        delete userSettings.calendar_colors[calName];
        const colorPicker = document.querySelector(`input[data-calendar="${calName}"]`);
        if (colorPicker) colorPicker.value = defaultColor;
        updateCalendarColorBadge(calName, defaultColor);
    };

    window.updateCalendarColor = function(calName, color) {
        userSettings.calendar_colors[calName] = color;
        updateCalendarColorBadge(calName, color);
    };

    window.resetAllColors = function() {
        if (confirm('Reset all calendar colors to their defaults?')) {
            userSettings.calendar_colors = {};
            loadCalendarList();
        }
    };

    window.randomizeColors = function() {
        if (confirm('Assign random colors to all calendars?')) {
            const availableColors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
                '#F8C471', '#82E0AA', '#F1948A', '#85CDFD', '#FABE58'
            ];
            
            document.querySelectorAll('.color-picker').forEach((picker, index) => {
                const randomColor = availableColors[index % availableColors.length];
                picker.value = randomColor;
                updateCalendarColor(picker.dataset.calendar, randomColor);
            });
        }
    };
});
</script>
{% endblock %} getTimeFromPosition(e, view) {
        try {
            const timeCols = document.querySelector('.fc-timegrid-cols');
            if (!timeCols) {
                return null;
            }
            
            const rect = timeCols.getBoundingClientRect();
            const relativeY = e.clientY - rect.top;
            
            const scrollEl = document.querySelector('.fc-scroller');
            const scrollTop = scrollEl ? scrollEl.scrollTop : 0;
            const adjustedY = relativeY + scrollTop;
            
            // Calculate time with 30-minute rounding
            const hourHeight = rect.height / 24;
            const totalHours = Math.max(0, Math.min(24, adjustedY / hourHeight));
            
            const hours = Math.floor(totalHours);
            const fractionalHour = totalHours - hours;
            const totalMinutes = fractionalHour * 60;
            // Round to nearest 30 minutes
            const minutes = Math.round(totalMinutes / 30) * 30;
            
            // Handle edge case where minutes might round to 60
            const finalHours = minutes >= 60 ? hours + 1 : hours;
            const finalMinutes = minutes >= 60 ? 0 : minutes;
            
            const timeString = `${finalHours.toString().padStart(2, '0')}:${finalMinutes.toString().padStart(2, '0')}`;
            const datetime = new Date();
            datetime.setHours(finalHours, finalMinutes, 0, 0);
            
            return {
                time: timeString,
                datetime: datetime
            };
        } catch (error) {
            return null;
        }
    }
    
    calendarEl.addEventListener('mousemove', function(e) {
        if (isSelecting) {
            // Day grid selection logic (existing)
            const dayEl = e.target.closest('.fc-daygrid-day');
            if (dayEl) {
                const currentDate = dayEl.getAttribute('data-date');
                if (currentDate && currentDate !== selectionEnd) {
                    const currentDateObj = new Date(currentDate);
                    const startDateObj = new Date(selectionStart);
                    const furthestDateObj = new Date(furthestDate);
                    
                    const currentDistance = Math.abs(currentDateObj - startDateObj);
                    const furthestDistance = Math.abs(furthestDateObj - startDateObj);
                    
                    if (currentDistance >= furthestDistance) {
                        furthestDate = currentDate;
                        selectionEnd = currentDate;
                        updateSelectionVisual();
                    }
                }
            }
        } else if (isTimeSelecting) {
            // Time grid selection logic
            const currentView = calendar.view;
            
            // Find day date using same logic as mousedown
            let dayDate = null;
            
            // For day view, use the current view date
            if (currentView.type === 'timeGridDay') {
                dayDate = currentView.currentStart.toISOString().split('T')[0];
            } else {
                // For week view, try to find the column
                const col = e.target.closest('.fc-timegrid-col');
                if (col) {
                    dayDate = col.getAttribute('data-date');
                }
                // Add other fallback methods if needed for week view
                if (!dayDate) {
                    const colIndex = Array.from(col?.parentElement?.children || []).indexOf(col);
                    const headerCells = document.querySelectorAll('.fc-col-header-cell');
                    if (headerCells[colIndex]) {
                        dayDate = headerCells[colIndex].getAttribute('data-date');
                    }
                }
            }
            
            if (dayDate) {
                const timeInfo = getTimeFromPosition(e, currentView);
                if (timeInfo) {
                    timeSelectionEnd = {
                        date: dayDate,
                        time: timeInfo.time,
                        datetime: timeInfo.datetime
                    };
                }
            }
        }
    });
    
    function updateSelectionVisual() {
        // Remove previous selection classes
        document.querySelectorAll('.fc-daygrid-day.selecting').forEach(el => {
            el.classList.remove('selecting');
        });
        
        if (selectionStart && selectionEnd) {
            const startDateObj = new Date(selectionStart);
            const endDateObj = new Date(selectionEnd);
            const actualStart = startDateObj <= endDateObj ? startDateObj : endDateObj;
            const actualEnd = startDateObj <= endDateObj ? endDateObj : startDateObj;
            
            document.querySelectorAll('.fc-daygrid-day').forEach(dayEl => {
                const dayDate = new Date(dayEl.getAttribute('data-date'));
                if (dayDate >= actualStart && dayDate <= actualEnd) {
                    dayEl.classList.add('selecting');
                }
            });
        }
    }
    
    calendarEl.addEventListener('mouseup', function(e) {
        if (isSelecting) {
            // Day grid selection end
            const finalEnd = furthestDate || selectionStart;
            
            document.querySelectorAll('.fc-daygrid-day.selecting').forEach(el => {
                el.classList.remove('selecting');
            });
            
            if (selectionStart && finalEnd) {
                const startDate = new Date(selectionStart);
                const endDate = new Date(finalEnd);
                const actualStart = startDate <= endDate ? startDate : endDate;
                const actualEnd = startDate <= endDate ? endDate : startDate;
                const isMultiDay = selectionStart !== finalEnd;
                
                openEventModal(null, null, {
                    startDate: actualStart.toISOString().split('T')[0],
                    endDate: actualEnd.toISOString().split('T')[0],
                    isMultiDay: isMultiDay
                });
            }
            
            isSelecting = false;
            selectionStart = null;
            selectionEnd = null;
            furthestDate = null;
        } else if (isTimeSelecting) {
            // Time grid selection end - calculate final end time from mouse position with 30-minute rounding
            const currentView = calendar.view;
            let finalTimeSelectionEnd = timeSelectionEnd;
            
            // Get final time from mouse position at release
            if (currentView.type === 'timeGridDay') {
                const dayDate = currentView.currentStart.toISOString().split('T')[0];
                const timeInfo = getTimeFromPosition(e, currentView);
                if (timeInfo) {
                    finalTimeSelectionEnd = {
                        date: dayDate,
                        time: timeInfo.time,
                        datetime: timeInfo.datetime
                    };
                }
            }
            
            if (timeSelectionStart && finalTimeSelectionEnd) {
                const startDate = timeSelectionStart.date;
                const endDate = finalTimeSelectionEnd.date;
                const startTime = timeSelectionStart.time;
                const endTime = finalTimeSelectionEnd.time;
                
                let startDateTime = new Date(`${startDate}T${startTime}`);
                let endDateTime = new Date(`${endDate}T${endTime}`);
                
                // If end is same as start, add 30 minutes
                if (endDateTime.getTime() === startDateTime.getTime()) {
                    endDateTime = new Date(startDateTime.getTime() + 30 * 60 * 1000);
                }
                
                // If end is before start, swap them
                if (endDateTime < startDateTime) {
                    [startDateTime, endDateTime] = [endDateTime, startDateTime];
                }
                
                const finalStartDate = startDateTime.toISOString().split('T')[0];
                const finalEndDate = endDateTime.toISOString().split('T')[0];
                const finalStartTime = startDateTime.toTimeString().slice(0, 5);
                const finalEndTime = endDateTime.toTimeString().slice(0, 5);
                
                const isMultiDay = finalStartDate !== finalEndDate;
                
                openEventModal(null, null, {
                    startDate: finalStartDate,
                    endDate: finalEndDate,
                    startTime: finalStartTime,
                    endTime: finalEndTime,
                    isMultiDay: isMultiDay,
                    isTimed: true
                });
            }
            
            isTimeSelecting = false;
            timeSelectionStart = null;
            timeSelectionEnd = null;
        }
    });
    
    // Handle mouseup outside calendar
    document.addEventListener('mouseup', function(e) {
        if (isSelecting) {
            document.querySelectorAll('.fc-daygrid-day.selecting').forEach(el => {
                el.classList.remove('selecting');
            });
            isSelecting = false;
            selectionStart = null;
            selectionEnd = null;
            furthestDate = null;
        }
        
        if (isTimeSelecting) {
            isTimeSelecting = false;
            timeSelectionStart = null;
            timeSelectionEnd = null;
        }
    });
    
    // Load calendar list and settings
    loadCalendarList();
    loadSettings();
    
    // Add session check
    console.log('Checking session status...');
    fetch('/debug')
        .then(response => response.json())
        .then(data => {
            console.log('Debug info:', data);
            if (!data.session_keys || data.session_keys.length === 0) {
                console.warn('No session detected - user may need to log in');
                calendarListEl.innerHTML = '<div class="text-warning">Not logged in - <a href="/login">Please log in</a></div>';
            }
        })
        .catch(error => {
            console.error('Error checking debug info:', error);
        });

    function loadSettings() {
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                userSettings = data;
                calendar.setOption('firstDay', data.week_start || 0);
                document.getElementById('weekStart').value = data.week_start || 0;
                
                // Set default calendar if available
                if (data.default_calendar) {
                    document.getElementById('defaultCalendar').value = data.default_calendar;
                }
            })
            .catch(error => {
                console.error('Error loading settings:', error);
            });
    }

    function loadCalendarList() {
        console.log('loadCalendarList called');
        
        // Show loading state with more info
        calendarListEl.innerHTML = '<div class="text-info">Loading calendars... (checking API)</div>';
        
        fetch('/api/calendar-selection')
            .then(response => {
                console.log('Calendar selection response status:', response.status);
                console.log('Calendar selection response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Calendar selection data:', data);
                
                if (data.error) {
                    console.error('API returned error:', data.error);
                    calendarListEl.innerHTML = `<div class="text-danger">API Error: ${data.error}</div>`;
                    return;
                }
                
                if (data.calendars && Array.isArray(data.calendars)) {
                    console.log('Found calendars:', data.calendars.length);
                    userSettings.calendar_colors = data.calendar_colors || {};
                    updateCalendarSidebar(data.calendars, data.selected_calendars || []);
                    updateColorSettings(data.calendars);
                    updateEventCalendarSelector(data.calendars);
                } else {
                    console.warn('No calendars array found in response:', data);
                    calendarListEl.innerHTML = '<div class="text-warning">No calendars found in response</div>';
                }
            })
            .catch(error => {
                console.error('Error loading calendar list:', error);
                calendarListEl.innerHTML = `<div class="text-danger">Network Error: ${error.message}<br><small>Check browser console for details</small></div>`;
            });
    }

    function