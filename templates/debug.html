{% extends "base.html" %}

{% block title %}Debug Interface - CalDAV Web Client{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>CalDAV Debug Interface</h4>
                    <p class="mb-0 text-muted">Use this interface to debug CalDAV connection and event issues.</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Debug Calendar Contents</h5>
                                </div>
                                <div class="card-body">
                                    <p>Inspect what's actually in your calendar:</p>
                                    <div class="mb-3">
                                        <label for="debugCalendar" class="form-label">Calendar Name</label>
                                        <select class="form-select" id="debugCalendar">
                                            <option value="">Select a calendar...</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" onclick="debugCalendar()">Debug Calendar</button>
                                    <div id="debugResults" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Create Test Event</h5>
                                </div>
                                <div class="card-body">
                                    <p>Create a test recurring event to verify functionality:</p>
                                    <div class="mb-3">
                                        <label for="testCalendar" class="form-label">Calendar Name</label>
                                        <select class="form-select" id="testCalendar">
                                            <option value="">Select a calendar...</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-success" onclick="createTestEvent()">Create Test Event</button>
                                    <div id="testResults" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Manual Event Creation Test</h5>
                                </div>
                                <div class="card-body">
                                    <form id="manualEventForm">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="eventTitle" class="form-label">Title</label>
                                                    <input type="text" class="form-control" id="eventTitle" value="Test Event">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="eventCalendar" class="form-label">Calendar</label>
                                                    <select class="form-select" id="eventCalendar">
                                                        <option value="">Select a calendar...</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="eventDate" class="form-label">Date</label>
                                                    <input type="date" class="form-control" id="eventDate">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="eventStartTime" class="form-label">Start Time</label>
                                                    <input type="time" class="form-control" id="eventStartTime" value="10:00">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="eventEndTime" class="form-label">End Time</label>
                                                    <input type="time" class="form-control" id="eventEndTime" value="11:00">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="recurring" class="form-label">Recurring</label>
                                                    <select class="form-select" id="recurring">
                                                        <option value="none">No</option>
                                                        <option value="daily">Daily</option>
                                                        <option value="weekly">Weekly</option>
                                                        <option value="monthly">Monthly</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="recurringCount" class="form-label">Count</label>
                                                    <input type="number" class="form-control" id="recurringCount" value="3" min="1" max="10">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <button type="button" class="btn btn-primary" onclick="createManualEvent()">Create Event</button>
                                    </form>
                                    <div id="manualResults" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Debug Log</h5>
                                </div>
                                <div class="card-body">
                                    <div id="debugLog" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px;">
                                        Debug output will appear here...
                                    </div>
                                    <button class="btn btn-secondary btn-sm mt-2" onclick="clearLog()">Clear Log</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let debugLog = document.getElementById('debugLog');
    
    function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const className = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
        debugLog.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        debugLog.scrollTop = debugLog.scrollHeight;
    }
    
    function clearLog() {
        debugLog.innerHTML = 'Debug output will appear here...';
    }
    
    // Load calendars on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadCalendars();
        
        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('eventDate').value = today;
    });
    
    function loadCalendars() {
        log('Loading calendars...');
        
        fetch('/api/calendar-selection')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    log(`Error loading calendars: ${data.error}`, 'error');
                    return;
                }
                
                const calendars = data.calendars || [];
                log(`Found ${calendars.length} calendars`, 'success');
                
                // Populate all calendar selectors
                const selectors = ['debugCalendar', 'testCalendar', 'eventCalendar'];
                selectors.forEach(selectorId => {
                    const selector = document.getElementById(selectorId);
                    selector.innerHTML = '<option value="">Select a calendar...</option>';
                    
                    calendars.forEach(cal => {
                        const calName = Array.isArray(cal) ? cal[0] : cal;
                        const option = document.createElement('option');
                        option.value = calName;
                        option.textContent = calName;
                        selector.appendChild(option);
                    });
                });
            })
            .catch(error => {
                log(`Network error loading calendars: ${error.message}`, 'error');
            });
    }
    
    function debugCalendar() {
        const calendarName = document.getElementById('debugCalendar').value;
        if (!calendarName) {
            log('Please select a calendar to debug', 'error');
            return;
        }
        
        log(`Debugging calendar: ${calendarName}`);
        document.getElementById('debugResults').innerHTML = '<div class="spinner-border spinner-border-sm"></div> Debugging...';
        
        fetch(`/debug/calendar?calendar=${encodeURIComponent(calendarName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    log(`Debug error: ${data.error}`, 'error');
                    document.getElementById('debugResults').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    log('Debug completed - check server logs for details', 'success');
                    document.getElementById('debugResults').innerHTML = '<div class="alert alert-success">Debug info written to server logs. Check your Docker logs or terminal output.</div>';
                }
            })
            .catch(error => {
                log(`Debug request failed: ${error.message}`, 'error');
                document.getElementById('debugResults').innerHTML = `<div class="alert alert-danger">Request failed: ${error.message}</div>`;
            });
    }
    
    function createTestEvent() {
        const calendarName = document.getElementById('testCalendar').value;
        if (!calendarName) {
            log('Please select a calendar for test event', 'error');
            return;
        }
        
        log(`Creating test event in: ${calendarName}`);
        document.getElementById('testResults').innerHTML = '<div class="spinner-border spinner-border-sm"></div> Creating...';
        
        fetch('/debug/create-test-event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ calendar_name: calendarName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                log(`Test event error: ${data.error}`, 'error');
                document.getElementById('testResults').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            } else {
                log('Test event created successfully', 'success');
                document.getElementById('testResults').innerHTML = '<div class="alert alert-success">Test event created! Check your calendar.</div>';
            }
        })
        .catch(error => {
            log(`Test event request failed: ${error.message}`, 'error');
            document.getElementById('testResults').innerHTML = `<div class="alert alert-danger">Request failed: ${error.message}</div>`;
        });
    }
    
    function createManualEvent() {
        const title = document.getElementById('eventTitle').value;
        const calendar = document.getElementById('eventCalendar').value;
        const date = document.getElementById('eventDate').value;
        const startTime = document.getElementById('eventStartTime').value;
        const endTime = document.getElementById('eventEndTime').value;
        const recurring = document.getElementById('recurring').value;
        const count = document.getElementById('recurringCount').value;
        
        if (!title || !calendar || !date) {
            log('Please fill in all required fields', 'error');
            return;
        }
        
        log(`Creating manual event: ${title}`);
        document.getElementById('manualResults').innerHTML = '<div class="spinner-border spinner-border-sm"></div> Creating...';
        
        const eventData = {
            title: title,
            description: 'Manual test event created via debug interface',
            location: 'Debug Location',
            start: `${date}T${startTime}:00`,
            end: `${date}T${endTime}:00`,
            calendar_name: calendar,
            recurring: recurring
        };
        
        if (recurring !== 'none') {
            eventData.recurring_count = count;
        }
        
        fetch('/api/events', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(eventData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                log(`Manual event error: ${data.error}`, 'error');
                document.getElementById('manualResults').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            } else {
                log('Manual event created successfully', 'success');
                document.getElementById('manualResults').innerHTML = '<div class="alert alert-success">Event created! Refresh your calendar view.</div>';
            }
        })
        .catch(error => {
            log(`Manual event request failed: ${error.message}`, 'error');
            document.getElementById('manualResults').innerHTML = `<div class="alert alert-danger">Request failed: ${error.message}</div>`;
        });
    }
</script>
{% endblock %}